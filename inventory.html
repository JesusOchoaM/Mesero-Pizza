<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Just Great Pizza</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #FF9800;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .form-container, .inventory-container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background-color: #2c2c2c;
            color: #fff;
            box-sizing: border-box;
        }
        button {
            background-color: #FF9800;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            grid-column: 1 / -1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
            color: #FF9800;
        }
        .low-stock {
            background-color: #8B0000; /* Rojo oscuro */
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            width: auto;
        }
        .btn-edit { background-color: #03A9F4; color: white; }
        .btn-delete { background-color: #f44336; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ“¦ GestiÃ³n de Inventario</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="temp-load-btn" style="background-color: #f44336; color: white; width: auto; padding: 10px 20px;">âš¡ Cargar Lista Inicial</button>
        </div>

        <div class="form-container">
            <div id="inventory-form" class="form-grid">
                <input type="text" id="barcode" placeholder="CÃ³digo de Barra" autofocus>
                <input type="text" id="product-name" placeholder="Nombre del Producto">
                <select id="category">
                    <option value="Embutidos">Embutidos</option>
                    <option value="Lactosa">Lactosa</option>
                    <option value="Congelados">Congelados</option>
                    <option value="PriceSmart">PriceSmart</option>
                    <option value="Otros">Otros</option>
                </select>
                <input type="number" id="quantity" placeholder="Cantidad">
                <select id="unit">
                    <option value="lb">lb</option>
                    <option value="uni">uni</option>
                    <option value="paq">paq</option>
                    <option value="lata">lata</option>
                    <option value="orden">orden</option>
                    <option value="porcentaje">porcentaje</option>
                    <option value="libra">libra</option>
                </select>
                <button id="add-update-btn">âž• Agregar / Actualizar Stock</button>
            </div>
        </div>

        <div class="inventory-container">
            <h2>Stock Actual</h2>
            <div style="overflow-x:auto;">
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Nombre</th>
                            <th>CategorÃ­a</th>
                            <th>Cantidad Actual</th>
                            <th>Unidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <!-- Filas de inventario -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBHTqTXaNChhDaskwJTzQGTBfyxR_Qq0nI",
          authDomain: "just-great-pizza-system.firebaseapp.com",
          projectId: "just-great-pizza-system",
          storageBucket: "just-great-pizza-system.firebasestorage.app",
          messagingSenderId: "30074620354",
          appId: "1:30074620354:web:4f1f36fad96ac2cad2ae5b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const inventoryCollection = db.collection("inventario");

        const barcodeInput = document.getElementById('barcode');
        const nameInput = document.getElementById('product-name');
        const categoryInput = document.getElementById('category');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');
        const addUpdateBtn = document.getElementById('add-update-btn');
        const inventoryBody = document.getElementById('inventory-body');
        const tempLoadBtn = document.getElementById('temp-load-btn');

        // --- CARGA INICIAL (TEMPORAL) ---
        tempLoadBtn.addEventListener('click', async () => {
            if (!confirm("Â¿EstÃ¡s seguro de que quieres cargar la lista inicial? Esto puede sobrescribir datos existentes si los cÃ³digos coinciden.")) {
                return;
            }

            const initialData = [
                // EMBUTIDOS
                { name: 'Chorizo', category: 'Embutidos', unit: 'uni' },
                { name: 'Peperoni', category: 'Embutidos', unit: 'lb' },
                { name: 'JamÃ³n ahumado', category: 'Embutidos', unit: 'lb' },
                { name: 'JamÃ³n pavo', category: 'Embutidos', unit: 'paq' }, // Corregido de 'bandeja' a 'paq'
                { name: 'Tocino', category: 'Embutidos', unit: 'uni' },
                { name: 'Salchicha con queso', category: 'Embutidos', unit: 'paq' },
                // LACTOSA
                { name: 'Queso mozzarella', category: 'Lactosa', unit: 'lb' },
                { name: 'Queso amarillo', category: 'Lactosa', unit: 'uni' },
                { name: 'Crema', category: 'Lactosa', unit: 'uni' },
                { name: 'Yogurt', category: 'Lactosa', unit: 'uni' },
                // MULTI CONGELADOS
                { name: 'Papas', category: 'Congelados', unit: 'lb' },
                { name: 'Nuguet pollo', category: 'Congelados', unit: 'uni' },
                { name: 'Pan hamburguesa', category: 'Congelados', unit: 'uni' },
                { name: 'Pechugas', category: 'Congelados', unit: 'orden' },
                { name: 'Tacos', category: 'Congelados', unit: 'orden' },
                // PRICE SMART
                { name: 'Camarones', category: 'PriceSmart', unit: 'uni' },
                { name: 'Deditos de queso', category: 'PriceSmart', unit: 'orden' },
                { name: 'Pollo', category: 'PriceSmart', unit: 'uni' },
                { name: 'Costilla', category: 'PriceSmart', unit: 'orden' },
                { name: 'BBQ', category: 'PriceSmart', unit: 'uni' },
                { name: 'BÃºfalo', category: 'PriceSmart', unit: 'uni' },
                { name: 'Ranch', category: 'PriceSmart', unit: 'uni' },
                { name: 'Ketchup', category: 'PriceSmart', unit: 'uni' },
                { name: 'Ketchup bolsita', category: 'PriceSmart', unit: 'uni' },
                { name: 'Aluminio', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Mayonesa', category: 'PriceSmart', unit: 'uni' },
                { name: 'Margarina', category: 'PriceSmart', unit: 'uni' },
                { name: 'Agua', category: 'PriceSmart', unit: 'uni' },
                { name: 'Salsa pizza', category: 'PriceSmart', unit: 'lata' },
                { name: 'Aceite', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Aceitunas', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Hongos', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'AzÃºcar', category: 'PriceSmart', unit: 'libra' },
                { name: 'Sal', category: 'PriceSmart', unit: 'libra' },
                { name: 'LimÃ³n', category: 'PriceSmart', unit: 'uni' },
                { name: 'Harina pan cake', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Nutella', category: 'PriceSmart', unit: 'uni' },
                { name: 'Hershey', category: 'PriceSmart', unit: 'uni' },
                { name: 'Chantilly', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Salsa negra', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Mostaza', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Jugo de Naranja', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Leche', category: 'PriceSmart', unit: 'porcentaje' },
                { name: 'Salsa Alfredo', category: 'PriceSmart', unit: 'uni' },
                { name: 'Wantan', category: 'PriceSmart', unit: 'orden' },
            ];

            const batch = db.batch();
            initialData.forEach(item => {
                // Usar el nombre como ID (cÃ³digo de barras), en minÃºsculas y sin espacios
                const docId = item.name.toLowerCase().replace(/\s+/g, '-');
                const docRef = inventoryCollection.doc(docId);
                batch.set(docRef, { ...item, quantity: 0 });
            });

            try {
                await batch.commit();
                alert('Â¡Lista inicial cargada con Ã©xito! Todos los items se inicializaron con cantidad 0.');
            } catch (error) {
                console.error("Error al cargar la lista inicial: ", error);
                alert('Hubo un error al cargar la lista. Revisa la consola.');
            }
        });


        // Buscar producto al presionar Enter en cÃ³digo de barra
        barcodeInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (!barcode) return;

                const doc = await inventoryCollection.doc(barcode).get();
                if (doc.exists) {
                    const data = doc.data();
                    nameInput.value = data.name;
                    categoryInput.value = data.category;
                    unitInput.value = data.unit;
                    quantityInput.focus(); // Mover foco a cantidad
                } else {
                    nameInput.value = ''; // Limpiar por si habÃ­a un valor
                    categoryInput.value = 'Embutidos'; // Reset
                    unitInput.value = 'lb'; // Reset
                    nameInput.focus(); // Mover foco a nombre para nuevo producto
                }
            }
        });

        // Agregar o actualizar producto
        addUpdateBtn.addEventListener('click', async () => {
            const barcode = barcodeInput.value.trim();
            const name = nameInput.value.trim();
            const category = categoryInput.value;
            const quantity = parseFloat(quantityInput.value);
            const unit = unitInput.value;

            if (!barcode || !name || isNaN(quantity)) {
                alert('Por favor, completa CÃ³digo, Nombre y Cantidad.');
                return;
            }

            const docRef = inventoryCollection.doc(barcode);
            const doc = await docRef.get();

            try {
                if (doc.exists) {
                    // Actualizar (sumar) cantidad
                    await docRef.update({
                        quantity: firebase.firestore.FieldValue.increment(quantity)
                    });
                } else {
                    // Crear nuevo producto
                    await docRef.set({ name, category, quantity, unit });
                }
                 // Limpiar formulario y resetear foco
                barcodeInput.value = '';
                nameInput.value = '';
                quantityInput.value = '';
                barcodeInput.focus();
            } catch (error) {
                console.error("Error al guardar en Firestore: ", error);
                alert("Error al guardar el producto.");
            }
        });

        // Escuchar cambios en el inventario y mostrar en la tabla
        inventoryCollection.onSnapshot(snapshot => {
            inventoryBody.innerHTML = ''; // Limpiar tabla
            const items = [];
            snapshot.forEach(doc => {
                items.push({ id: doc.id, ...doc.data() });
            });

            // Ordenar por nombre
            items.sort((a, b) => a.name.localeCompare(b.name));

            items.forEach(item => {
                const row = document.createElement('tr');
                if (item.quantity < 5) {
                    row.classList.add('low-stock');
                }

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">Editar</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">Borrar</button>
                    </td>
                `;
                inventoryBody.appendChild(row);
            });
        }, error => {
            console.error("Error al escuchar el inventario: ", error);
        });

        // Funciones de acciÃ³n
        window.editItem = async (id) => {
            const doc = await inventoryCollection.doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                barcodeInput.value = id;
                nameInput.value = data.name;
                categoryInput.value = data.category;
                unitInput.value = data.unit;
                quantityInput.value = data.quantity; // Cargar cantidad actual para ediciÃ³n
                
                // Cambiar el botÃ³n para reflejar la acciÃ³n de ediciÃ³n
                addUpdateBtn.textContent = 'ðŸ’¾ Actualizar Producto';
                addUpdateBtn.onclick = async () => { // Sobrescribir el evento click temporalmente
                    const updatedName = nameInput.value.trim();
                    const updatedCategory = categoryInput.value;
                    const updatedUnit = unitInput.value;
                    const updatedQuantity = parseFloat(quantityInput.value);

                    if (!id || !updatedName || isNaN(updatedQuantity)) {
                        alert('El cÃ³digo, nombre y cantidad son obligatorios.');
                        return;
                    }
                    
                    await inventoryCollection.doc(id).set({
                        name: updatedName,
                        category: updatedCategory,
                        unit: updatedUnit,
                        quantity: updatedQuantity
                    });

                    // Restaurar el formulario
                    barcodeInput.value = '';
                    nameInput.value = '';
                    quantityInput.value = '';
                    barcodeInput.focus();
                    addUpdateBtn.textContent = 'âž• Agregar / Actualizar Stock';
                    addUpdateBtn.onclick = addOrUpdateItem; // Restaurar el listener original
                };
            }
        };
        const addOrUpdateItem = addUpdateBtn.onclick; // Guardar la referencia a la funciÃ³n original

        window.deleteItem = async (id) => {
            if (confirm(`Â¿Seguro que quieres borrar el producto con cÃ³digo ${id}?`)) {
                await inventoryCollection.doc(id).delete();
            }
        };

    </script>
</body>
</html>
