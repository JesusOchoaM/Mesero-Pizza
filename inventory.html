<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Just Great Pizza</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #FF9800;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .form-container, .inventory-container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background-color: #2c2c2c;
            color: #fff;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #FF9800;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        #add-update-btn {
            grid-column: 1 / -1;
        }
        .barcode-container {
            display: flex;
            gap: 5px;
            grid-column: 1 / -1;
        }
        #scan-btn {
            width: auto;
            padding: 10px 15px;
            background-color: #03A9F4;
            color: white;
        }
        #reader {
            width: 300px;
            margin: 15px auto;
            border: 2px dashed #333;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
            color: #FF9800;
        }
        .low-stock {
            background-color: #8B0000;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            width: auto;
        }
        .btn-edit { background-color: #03A9F4; color: white; }
        .btn-delete { background-color: #f44336; color: white; }
        .category-title {
            background-color: #333;
            color: #FF9800;
            padding: 10px;
            border-radius: 5px;
            margin-top: 25px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="images/logo1.png" alt="Logo" style="width: 130px; height: auto; display: block; margin: 0 auto 10px auto;">
            <h1 style="color: #FF9800; margin: 0 0 15px 0;">üì¶ Gesti√≥n de Inventario</h1>
            
            <nav style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button id="ai-analysis-btn" style="background: transparent; border: 1px solid #8A2BE2; color: #8A2BE2; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 0.9rem; width: auto;">
                    ü§ñ Analizar con IA
                </button>
                <button id="close-day-btn" style="background: transparent; border: 1px solid #4CAF50; color: #4CAF50; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 0.9rem; width: auto;">
                    üìÖ Cerrar Inventario del D√≠a
                </button>
                <a href="index.html" style="color: #e74c3c; text-decoration: none; font-weight: bold; border: 1px solid #e74c3c; padding: 5px 15px; border-radius: 15px; font-size: 0.9rem;">
                    üçï Ir a Pedidos
                </a>
                <a href="kds.html" style="color: #e74c3c; text-decoration: none; font-weight: bold; border: 1px solid #e74c3c; padding: 5px 15px; border-radius: 15px; font-size: 0.9rem;">
                    üë®‚Äçüç≥ Ir a Cocina
                </a>
            </nav>
        </div>

        <div class="form-container">
            <div id="inventory-form" class="form-grid">
                <div class="barcode-container">
                    <input type="text" id="barcode" placeholder="C√≥digo (o deja vac√≠o para generar auto)" autofocus>
                    <button id="scan-btn">üì∑ Escanear</button>
                </div>
                <input type="text" id="product-name" placeholder="Nombre del Producto" list="catalog-list">
                <datalist id="catalog-list"></datalist>
                <input type='text' id='category' list='lista-marcas' placeholder='üîç Busca o escribe la Marca/Lugar...' />
                <datalist id="lista-marcas">
                    <optgroup label="LUGARES DE COMPRA">
                        <option value="EL MERCADO">EL MERCADO (Frutas/Verduras/Granel)</option>
                        <option value="PRICE SMART">PRICE SMART (Club)</option>
                        <option value="SUPER SELECTOS">SUPER SELECTOS</option>
                        <option value="TIENDA MAYORISTA">TIENDA MAYORISTA / DEP√ìSITO</option>
                    </optgroup>
                    <optgroup label="BEBIDAS (NO ALCOH√ìLICAS)">
                        <option value="COCA COLA COMPANY">COCA COLA / FANTA / SPRITE</option>
                        <option value="PEPSI (CBC)">PEPSI / 7UP / MIRINDA</option>
                        <option value="LA CASCADA">SALVA COLA / KOLASHAMPAN</option>
                        <option value="JUGOS DEL VALLE">JUGOS DEL VALLE / FRUTSI</option>
                        <option value="PETIT">JUGOS PETIT / CALIFORNIA</option>
                        <option value="AGUA CRISTAL">AGUA CRISTAL</option>
                        <option value="AGUA ALPINA">AGUA ALPINA</option>
                    </optgroup>
                    <optgroup label="BEBIDAS (ALCOH√ìLICAS)">
                        <option value="LA CONSTANCIA">PILSENER / SUPREMA / GOLDEN</option>
                        <option value="CERVEZA REGIA">CERVEZA REGIA</option>
                        <option value="HEINEKEN">HEINEKEN / OTRAS IMPORTADAS</option>
                    </optgroup>
                    <optgroup label="CARNES Y EMBUTIDOS">
                        <option value="TOLEDO">TOLEDO (Jamones/Embutidos)</option>
                        <option value="SIGMA">SIGMA / FUD</option>
                        <option value="CRIO">CRIO (Huevos/Pollo)</option>
                        <option value="SELLO DE ORO">SELLO DE ORO (Pollo/Procesados)</option>
                        <option value="POLLO INDIO">POLLO INDIO</option>
                        <option value="LA CHILA">LA CHILA (Chorizos)</option>
                    </optgroup>
                    <optgroup label="L√ÅCTEOS Y DERIVADOS">
                        <option value="LACTOSA">LACTOSA / LECHE ESPECIAL</option>
                        <option value="SALUD">LECHE SALUD</option>
                        <option value="SULA">SULA (Leche/Cremas)</option>
                        <option value="DOS PINOS">DOS PINOS</option>
                        <option value="FOREMOST">FOREMOST</option>
                        <option value="PETACONES">QUESOS PETACONES</option>
                        <option value="SAN JULIAN">SAN JULI√ÅN</option>
                    </optgroup>
                    <optgroup label="SALSAS, ESPECIAS Y ACEITES">
                        <option value="NATURAS">NATURA'S (Salsas de tomate)</option>
                        <option value="KERNS">KERN'S (Ketchup/Jugos)</option>
                        <option value="HELLMANNS">HELLMANN'S (Mayonesa)</option>
                        <option value="HEINZ">HEINZ (Ketchup/Salsas)</option>
                        <option value="CAMPBELLS">CAMPBELL'S (Prego)</option>
                        <option value="MAGGI">MAGGI (Sopas/Consom√©s)</option>
                        <option value="KNORR">KNORR (Sabrosador)</option>
                        <option value="CONTI">CONTI (Salsas/Especias)</option>
                        <option value="MCCORMICK">MCCORMICK (Especias/Mayonesa)</option>
                        <option value="BADIA">BADIA (Especias)</option>
                        <option value="MAZOLA">ACEITE MAZOLA / IDEAL</option>
                        <option value="ORISOL">ACEITE ORISOL / CLOVER</option>
                    </optgroup>
                    <optgroup label="SNACKS Y PANADER√çA">
                        <option value="DIANA">PRODUCTOS DIANA (Churritos/Dulces)</option>
                        <option value="BOCADELI">BOCADELI</option>
                        <option value="BIMBO">BIMBO / BREDDY</option>
                        <option value="LIDO">PAN LIDO (Postres)</option>
                        <option value="SINAI">PAN SINA√ç</option>
                        <option value="MASECA">MASECA (Harina Ma√≠z)</option>
                        <option value="HARINA GOLD MEDAL">GOLD MEDAL / SUAVE</option>
                    </optgroup>
                    <optgroup label="LIMPIEZA E HIGIENE">
                        <option value="SCOTT">SCOTT (Papel Higi√©nico/Toalla)</option>
                        <option value="ROSAL">ROSAL</option>
                        <option value="NUBE BLANCA">NUBE BLANCA</option>
                        <option value="RINSO">RINSO</option>
                        <option value="XEDEX">XEDEX</option>
                        <option value="AXION">AXION (Lavacrastes)</option>
                        <option value="MAGIA BLANCA">MAGIA BLANCA (Lej√≠a)</option>
                        <option value="SUAVITEL">SUAVITEL / DOWNY</option>
                        <option value="DESECHABLES">DESECHABLES (Platos/Vasos/Servilletas)</option>
                    </optgroup>
                    <optgroup label="OTROS">
                        <option value="VARIOS">OTRA MARCA / GEN√âRICO</option>
                    </optgroup>
                </datalist>
                <input type="number" id="quantity" placeholder="Cantidad">
                <select id="unit">
                    <option value="lb">lb</option>
                    <option value="uni">uni</option>
                    <option value="paq">paq</option>
                    <option value="lata">lata</option>
                    <option value="orden">orden</option>
                    <option value="porcentaje">porcentaje</option>
                    <option value="libra">libra</option>
                    <option value="bandeja">bandeja</option>
                    <option value="bolsa">bolsa</option>
                </select>
                <button id="add-update-btn">‚ûï Agregar / Actualizar Stock</button>
            </div>
            <div id="reader" style="display: none;"></div>
        </div>

        <div class="inventory-container">
            <h2>Stock Actual</h2>
            <input type="text" id="search-inventory" placeholder="üîç Buscar producto en stock...">
            <div id="inventory-display" style="overflow-x:auto;">
                <!-- El inventario agrupado se generar√° aqu√≠ -->
            </div>
        </div>

        <div class="inventory-container report-container">
            <h2>üìä Reporte Semanal</h2>
            <div class="report-controls" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <input type="date" id="week-picker" style="padding: 8px; background-color: #2c2c2c; color: #fff; border: 1px solid #333; border-radius: 5px;">
                <button id="export-csv-btn" style="background-color: #2196F3; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none;">Exportar Semana a CSV</button>
                <button id="delete-report-btn" style="background-color: #f44336; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none;">üóëÔ∏è Eliminar Reporte Mostrado</button>
            </div>
            <div id="weekly-report" style="overflow-x:auto;">
                <table id="report-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Mi√©rcoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                            <th>S√°bado</th>
                            <th>Domingo</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body">
                        <!-- Las filas del reporte se generar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBHTqTXaNChhDaskwJTzQGTBfyxR_Qq0nI",
          authDomain: "just-great-pizza-system.firebaseapp.com",
          projectId: "just-great-pizza-system",
          storageBucket: "just-great-pizza-system.firebasestorage.app",
          messagingSenderId: "30074620354",
          appId: "1:30074620354:web:4f1f36fad96ac2cad2ae5b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const inventoryCollection = db.collection("inventario");

        const barcodeInput = document.getElementById('barcode');
        const nameInput = document.getElementById('product-name');
        const categoryInput = document.getElementById('category');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');
        const addUpdateBtn = document.getElementById('add-update-btn');
        const scanBtn = document.getElementById('scan-btn');
        const readerDiv = document.getElementById('reader');

        let html5QrCode;

        scanBtn.addEventListener('click', () => {
            if (readerDiv.style.display === 'none') {
                readerDiv.style.display = 'block';
                startScanner();
            } else {
                stopScanner();
            }
        });

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const onScanSuccess = (decodedText, decodedResult) => {
                barcodeInput.value = decodedText;
                playBeep();
                stopScanner();
                const event = new KeyboardEvent('keypress', { key: 'Enter', bubbles: true });
                barcodeInput.dispatchEvent(event);
            };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    alert("Error al iniciar la c√°mara. Aseg√∫rate de dar los permisos necesarios.");
                    stopScanner();
                });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    readerDiv.style.display = 'none';
                    html5QrCode = null;
                }).catch(err => console.error("Error al detener el esc√°ner", err));
            }
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) { console.warn("No se pudo reproducir sonido de bip.") }
        }



        barcodeInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (!barcode) return;

                const doc = await inventoryCollection.doc(barcode).get();
                if (doc.exists) {
                    const data = doc.data();
                    nameInput.value = data.name;
                    categoryInput.value = data.category;
                    unitInput.value = data.unit;
                    quantityInput.focus();
                } else {
                    // Si no existe, prepara para ingreso manual y pone foco en el nombre
                    nameInput.value = '';
                    categoryInput.value = 'VARIOS (Generico)'; // O un valor por defecto
                    unitInput.value = 'uni';
                    nameInput.focus(); // <-- FOCO AUTOM√ÅTICO
                }
            }
        });
        
        const addOrUpdateItem = async () => {
            let barcode = barcodeInput.value.trim();
            const name = nameInput.value.trim();
            const category = categoryInput.value;
            const quantity = parseFloat(quantityInput.value);
            const unit = unitInput.value;

            if (barcode === '' && name !== '') {
                const generatedBarcode = name.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quita tildes
                    .replace(/[^a-z0-9\s-]/g, '') // Quita s√≠mbolos raros
                    .replace(/\s+/g, '-'); // Reemplaza espacios por guiones
                
                barcode = generatedBarcode;
                barcodeInput.value = barcode;
                console.log(`‚ú® C√≥digo generado autom√°ticamente: ${barcode}`);
            }

            if (!barcode || !name || isNaN(quantity)) {
                alert('Por favor, completa C√≥digo, Nombre y Cantidad.');
                return;
            }

            const docRef = inventoryCollection.doc(barcode);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (doc.exists) {
                        const newQuantity = quantity;
                        transaction.update(docRef, { 
                            name, 
                            category, 
                            quantity: newQuantity, 
                            unit 
                        });
                    } else {
                        transaction.set(docRef, { name, category, quantity, unit });
                    }
                });
                barcodeInput.value = '';
                nameInput.value = '';
                quantityInput.value = '';
                barcodeInput.focus();
            } catch (error) {
                alert("Error al guardar el producto.");
            }
        };
        addUpdateBtn.addEventListener('click', addOrUpdateItem);

        inventoryCollection.orderBy("category").orderBy("name").onSnapshot(snapshot => {
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';

            window.categoryMap = {}; // 1. Mapa de Categor√≠as Global
            const itemsByCategory = {};
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                window.categoryMap[item.name] = item.category; // Llenar el mapa

                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            const categoryOrder = Object.keys(itemsByCategory).sort();

            for (const category of categoryOrder) {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                inventoryDisplay.appendChild(categoryTitle);

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Cantidad Actual</th>
                            <th>Unidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                itemsByCategory[category].forEach(item => {
                    const row = document.createElement('tr');
                    if (item.quantity < 5 && item.unit !== 'porcentaje') {
                        row.classList.add('low-stock');
                    }
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editItem('${item.id}')">Editar</button>
                            <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">Borrar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                inventoryDisplay.appendChild(table);
            }
        }, error => { console.error("Error de √≠ndice:", error); alert("‚ö†Ô∏è Falta crear el √≠ndice en Firebase. Revisa la consola (F12) para ver el link."); });

        window.editItem = async (id) => {
            const doc = await inventoryCollection.doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                barcodeInput.value = id;
                nameInput.value = data.name;
                categoryInput.value = data.category;
                unitInput.value = data.unit;
                quantityInput.value = data.quantity;
                barcodeInput.disabled = true;
                
                addUpdateBtn.textContent = 'üíæ Actualizar Producto';
                addUpdateBtn.onclick = async () => {
                    const updatedName = nameInput.value.trim();
                    if (!id || !updatedName) return;
                    
                    await inventoryCollection.doc(id).set({
                        name: updatedName,
                        category: categoryInput.value,
                        unit: unitInput.value,
                        quantity: parseFloat(quantityInput.value) || 0
                    }, { merge: true });

                    barcodeInput.value = '';
                    nameInput.value = '';
                    quantityInput.value = '';
                    barcodeInput.disabled = false;
                    barcodeInput.focus();
                    addUpdateBtn.textContent = '‚ûï Agregar / Actualizar Stock';
                    addUpdateBtn.onclick = addOrUpdateItem;
                };
            }
        };

        window.deleteItem = async (id) => {
            if (confirm(`¬øSeguro que quieres borrar el producto '${id}'?`)) {
                await inventoryCollection.doc(id).delete();
            }
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const catalogList = document.getElementById('catalog-list');
            const aiAnalysisBtn = document.getElementById('ai-analysis-btn');

            const localProducts = [
                "Churritos Diana", "Nachos Diana", "Elotitos Diana", "Tortillitas Diana", "Pizzerolas Diana",
                "Bocadeli Nachos", "Bocadeli Frijoli Chips", "Bocadeli Papas Onduladas",
                "Cerveza Pilsener", "Cerveza Regia", "Cerveza Suprema", "Cerveza Golden",
                "Coca Cola", "Kolashampan", "Pepsi", "Mirinda", "7up",
                "Leche Salud", "Yogurt Sula", "Leche Leyde", "Queso Crio",
                "Jugo del Valle", "Jugo Petit",
                "Boquitas Diana Variedad",
                "Queso Mozzarella", "Queso Duro Blando", "Queso Oaxaca",
                "Cafe Riko", "Cafe Listo"
            ];

            localProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                catalogList.appendChild(option);
            });

            const analizarInventarioIA = () => {
                const rows = document.querySelectorAll('#inventory-display tbody tr');
                let criticos = 0;
                let exceso = 0;
                let valorTotal = 0;
                let productosCriticos = [];
                let hayCervezasBajas = false;
                let hayQuesoBajo = false;

                rows.forEach(row => {
                    const quantity = parseFloat(row.cells[2].textContent);
                    const name = row.cells[1].textContent.toLowerCase();
                    const id = row.cells[0].textContent.toLowerCase();

                    if (!isNaN(quantity)) {
                        if (quantity < 5) {
                            criticos++;
                            productosCriticos.push(row.cells[1].textContent);
                        }
                        if (quantity > 50) {
                            exceso++;
                        }
                        valorTotal += quantity; 

                        if (name.includes('cerveza') && quantity < 10) {
                            hayCervezasBajas = true;
                        }
                        if (id.includes('queso') && quantity < 2) {
                            hayQuesoBajo = true;
                        }
                    }
                });

                let consejo = "Todo parece en orden.";
                if (hayCervezasBajas) {
                    consejo = "Se detecta bajo inventario de cervezas. Sugerencia: Preparar pedido a La Constancia para el fin de semana.";
                }
                if (hayQuesoBajo) {
                    consejo = "¬°Alerta de cocina! Niveles de queso son cr√≠ticos. Hay riesgo de parar la producci√≥n de pizzas y pupusas.";
                }

                const analisis = `
                    An√°lisis de Inventario con IA completado:
                    - Productos Cr√≠ticos (<5 unidades): ${criticos}
                    - Productos en Exceso (>50 unidades): ${exceso}
                    - Total de Items: ${valorTotal.toFixed(2)}
                    
                    Consejo Inteligente: ${consejo}
                `;

                alert(analisis);

                if ('speechSynthesis' in window) {
                    const mensaje = new SpeechSynthesisUtterance(analisis);
                    window.speechSynthesis.speak(mensaje);
                }
            };

            aiAnalysisBtn.addEventListener('click', analizarInventarioIA);
        });
    </script>

    <script>
        document.getElementById('close-day-btn').addEventListener('click', async () => {
            if (!confirm('¬øEst√°s seguro de que quieres cerrar el inventario del d√≠a? Esta acci√≥n guardar√° una copia del stock actual y no se puede deshacer.')) {
                return;
            }

            const historialCollection = db.collection("historial_inventario");
            const inventarioSnapshot = await inventoryCollection.get();

            if (inventarioSnapshot.empty) {
                alert("No hay productos en el inventario para archivar.");
                return;
            }

            const batch = db.batch();
            const today = new Date();
            const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const dia_semana = dias[today.getDay()];

            inventarioSnapshot.forEach(doc => {
                const item = doc.data();
                const historialDocRef = historialCollection.doc(); // Crea un nuevo documento con ID autom√°tico

                batch.set(historialDocRef, {
                    id_producto: doc.id,
                    nombre: item.name,
                    categoria: item.category, // 2. Guardar Categor√≠a en Historial Futuro
                    cantidad: item.quantity,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    dia_semana: dia_semana
                });
            });

            try {
                await batch.commit();
                alert('‚úÖ ¬°Cierre de inventario completado! Se ha guardado el registro del d√≠a.');
            } catch (error) {
                console.error("Error al cerrar el inventario: ", error);
                alert('‚ùå Hubo un error al guardar el historial de inventario. Por favor, revisa la consola.');
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const weekPicker = document.getElementById('week-picker');
            const exportBtn = document.getElementById('export-csv-btn');

            // Establecer la fecha actual en el selector
            weekPicker.valueAsDate = new Date();

            renderizarReporteSemanal(new Date());

            weekPicker.addEventListener('change', () => {
                const selectedDate = weekPicker.value ? new Date(weekPicker.value) : new Date();
                renderizarReporteSemanal(selectedDate);
            });

            exportBtn.addEventListener('click', exportarSemanaExcel);
        });

        let lastReportData = {}; // Variable global para guardar los datos del √∫ltimo reporte
        let lastStartDate = new Date(); // Variable global para guardar la fecha de inicio

        async function renderizarReporteSemanal(date) {
            const reportTableBody = document.getElementById('report-table-body');
            if (!reportTableBody) return;
            reportTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Cargando...</td></tr>';

            const targetDate = new Date(date); // Clonar la fecha para no modificar la original
            const dayOfWeek = targetDate.getDay();
            const diff = targetDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            
            const startOfWeek = new Date(targetDate.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0);
            lastStartDate = startOfWeek; // Guardar para el nombre del archivo

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            const historialCollection = db.collection("historial_inventario");
            const query = historialCollection
                .where('fecha', '>=', startOfWeek)
                .where('fecha', '<=', endOfWeek);

            try {
                const snapshot = await query.get();
                if (snapshot.empty) {
                    reportTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No hay datos para la semana seleccionada.</td></tr>';
                    lastReportData = {}; // Limpiar datos si no hay
                    return;
                }

                const reportData = {};
                const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

                snapshot.forEach(doc => {
                    const record = doc.data();
                    const productName = record.nombre;
                    const category = record.categoria || (window.categoryMap ? window.categoryMap[productName] : undefined) || 'Sin Categor√≠a';

                    if (!reportData[productName]) {
                        reportData[productName] = {
                            category: category,
                            days: {}
                        };
                    }
                    reportData[productName].days[record.dia_semana] = record.cantidad;
                });
                
                lastReportData = reportData; // Guardar los datos para exportar

                reportTableBody.innerHTML = '';
                const productNames = Object.keys(reportData).sort();

                for (const productName of productNames) {
                    const row = document.createElement('tr');
                    
                    const productCell = document.createElement('td');
                    productCell.textContent = productName;
                    row.appendChild(productCell);

                    diasSemana.forEach(dia => {
                        const quantityCell = document.createElement('td');
                        const quantity = reportData[productName].days[dia];
                        quantityCell.textContent = quantity !== undefined ? quantity : '-';
                        quantityCell.style.textAlign = 'center';
                        row.appendChild(quantityCell);
                    });

                    reportTableBody.appendChild(row);
                }

            } catch (error) {
                console.error("Error al generar el reporte semanal: ", error);
                reportTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Error al cargar el reporte.</td></tr>';
                lastReportData = {};
            }
        }

        function exportarSemanaExcel() {
            if (Object.keys(lastReportData).length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const dataBySheet = {};

            // Agrupar datos por categor√≠a (hoja)
            for (const productName in lastReportData) {
                const productData = lastReportData[productName];
                const category = productData.category || 'Sin Categor√≠a';
                
                if (!dataBySheet[category]) {
                    dataBySheet[category] = [];
                }
                
                const productRow = { 'Producto': productName };
                diasSemana.forEach(dia => {
                    productRow[dia] = productData.days[dia] !== undefined ? productData.days[dia] : '';
                });
                dataBySheet[category].push(productRow);
            }

            const wb = XLSX.utils.book_new();

            // Crear una hoja para cada categor√≠a
            for (const categoryName in dataBySheet) {
                // Ordenar productos alfab√©ticamente dentro de cada categor√≠a
                const sortedProducts = dataBySheet[categoryName].sort((a, b) => a.Producto.localeCompare(b.Producto));
                
                const ws = XLSX.utils.json_to_sheet(sortedProducts, {
                    header: ['Producto', ...diasSemana]
                });

                // Limpiar el nombre de la hoja para que sea v√°lido (<= 31 chars, no chars prohibidos)
                const safeSheetName = categoryName.substring(0, 31).replace(/[:\\/?*[\]]/g, '');
                XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
            }

            // Descargar el archivo
            const startDateString = lastStartDate.toISOString().split('T')[0];
            XLSX.writeFile(wb, `Reporte_Inventario_${startDateString}.xlsx`);
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const deleteReportBtn = document.getElementById('delete-report-btn');

            deleteReportBtn.addEventListener('click', async () => {
                if (!confirm('¬øEst√°s seguro de borrar el historial de la semana seleccionada? Esto no se puede deshacer.')) {
                    return;
                }

                const startOfWeek = new Date(lastStartDate);
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                const historialCollection = db.collection("historial_inventario");
                const query = historialCollection
                    .where('fecha', '>=', startOfWeek)
                    .where('fecha', '<=', endOfWeek);

                try {
                    const snapshot = await query.get();
                    if (snapshot.empty) {
                        alert('No hay datos para borrar en la semana seleccionada.');
                        return;
                    }

                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    alert('Reporte eliminado correctamente.');
                    renderizarReporteSemanal(new Date(lastStartDate));

                } catch (error) {
                    console.error("Error al eliminar el reporte: ", error);
                    alert('Hubo un error al eliminar el reporte.');
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-inventory');
            if (searchInput) {
                searchInput.addEventListener('keyup', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const inventoryDisplay = document.getElementById('inventory-display');
                    const categories = inventoryDisplay.querySelectorAll('.category-title');

                    categories.forEach(category => {
                        const table = category.nextElementSibling;
                        const rows = table.querySelectorAll('tbody tr');
                        let visibleRows = 0;

                        rows.forEach(row => {
                            const code = row.cells[0].textContent.toLowerCase();
                            const name = row.cells[1].textContent.toLowerCase();

                            if (code.includes(searchTerm) || name.includes(searchTerm)) {
                                row.style.display = '';
                                visibleRows++;
                            } else {
                                row.style.display = 'none';
                            }
                        });

                        // Ocultar la categor√≠a si no tiene filas visibles
                        if (visibleRows === 0) {
                            category.style.display = 'none';
                            table.style.display = 'none';
                        } else {
                            category.style.display = '';
                            table.style.display = '';
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
