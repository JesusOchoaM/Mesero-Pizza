<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Just Great Pizza</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #FF9800;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .form-container, .inventory-container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background-color: #2c2c2c;
            color: #fff;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #FF9800;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        #add-update-btn {
            grid-column: 1 / -1;
        }
        .barcode-container {
            display: flex;
            gap: 5px;
            grid-column: 1 / -1;
        }
        #scan-btn {
            width: auto;
            padding: 10px 15px;
            background-color: #03A9F4;
            color: white;
        }
        #reader {
            width: 300px;
            margin: 15px auto;
            border: 2px dashed #333;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
            color: #FF9800;
        }
        .low-stock {
            background-color: #8B0000;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            width: auto;
        }
        .btn-edit { background-color: #03A9F4; color: white; }
        .btn-delete { background-color: #f44336; color: white; }
        .category-title {
            background-color: #333;
            color: #FF9800;
            padding: 10px;
            border-radius: 5px;
            margin-top: 25px;
        }
    </style>
</head>
<body>

    <button id="btn-wipe-all" style="background-color: #f44336; color: white; padding: 15px; width: 100%; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-bottom: 20px;">üóëÔ∏è BORRAR TODO EL INVENTARIO (RESET)</button>

    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="ai-analysis-btn" style="background: linear-gradient(90deg, #8A2BE2, #00BFFF); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #00BFFF;">ü§ñ Analizar Inventario con IA</button>
        </div>
        <h1>üì¶ Gesti√≥n de Inventario</h1>

        <div class="form-container">
            <div id="inventory-form" class="form-grid">
                <div class="barcode-container">
                    <input type="text" id="barcode" placeholder="C√≥digo de Barra" autofocus>
                    <button id="scan-btn">üì∑ Escanear</button>
                </div>
                <input type="text" id="product-name" placeholder="Nombre del Producto" list="catalog-list">
                <datalist id="catalog-list"></datalist>
                <select id="category">
                    <option value="PRICE SMART">PRICE SMART</option>
                    <option value="SUPER SELECTOS">SUPER SELECTOS</option>
                    <option value="DESPENSA DE DON JUAN">DESPENSA DE DON JUAN</option>
                    <option value="EL MERCADO">EL MERCADO (Frutas/Verduras)</option>
                    <option value="LA CONSTANCIA">LA CONSTANCIA (CocaCola, Pilsener, Cristal)</option>
                    <option value="CBC">CBC (Pepsi, 7Up, Gatorade)</option>
                    <option value="INDUSTRIAS LA CASCADA">LA CASCADA (SalvaCola, Kolashampan)</option>
                    <option value="SIGMA">SIGMA / TOLEDO</option>
                    <option value="CRIO">CRIO</option>
                    <option value="SELLO DE ORO">SELLO DE ORO</option>
                    <option value="POLLO INDIO">POLLO INDIO</option>
                    <option value="LACTOSA">LACTOSA (Sula, Salud)</option>
                    <option value="DOS PINOS">DOS PINOS</option>
                    <option value="FOREMOST">FOREMOST</option>
                    <option value="PETACONES">QUESOS PETACONES</option>
                    <option value="PRODUCTOS DIANA">PRODUCTOS DIANA</option>
                    <option value="BOCADELI">BOCADELI</option>
                    <option value="BIMBO">BIMBO / BREDDY</option>
                    <option value="PAN LIDO">PAN LIDO</option>
                    <option value="PAN SINAI">PAN SINA√ç</option>
                    <option value="MASECA">MASECA / GRUMA</option>
                    <option value="LA SABROSURA">LA SABROSURA</option>
                    <option value="VARIOS">VARIOS / GENERIGO</option>
                </select>
                <input type="number" id="quantity" placeholder="Cantidad">
                <select id="unit">
                    <option value="lb">lb</option>
                    <option value="uni">uni</option>
                    <option value="paq">paq</option>
                    <option value="lata">lata</option>
                    <option value="orden">orden</option>
                    <option value="porcentaje">porcentaje</option>
                    <option value="libra">libra</option>
                    <option value="bandeja">bandeja</option>
                    <option value="bolsa">bolsa</option>
                </select>
                <button id="add-update-btn">‚ûï Agregar / Actualizar Stock</button>
            </div>
            <div id="reader" style="display: none;"></div>
        </div>

        <div class="inventory-container">
            <h2>Stock Actual</h2>
            <div id="inventory-display" style="overflow-x:auto;">
                <!-- El inventario agrupado se generar√° aqu√≠ -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBHTqTXaNChhDaskwJTzQGTBfyxR_Qq0nI",
          authDomain: "just-great-pizza-system.firebaseapp.com",
          projectId: "just-great-pizza-system",
          storageBucket: "just-great-pizza-system.firebasestorage.app",
          messagingSenderId: "30074620354",
          appId: "1:30074620354:web:4f1f36fad96ac2cad2ae5b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const inventoryCollection = db.collection("inventario");

        const barcodeInput = document.getElementById('barcode');
        const nameInput = document.getElementById('product-name');
        const categoryInput = document.getElementById('category');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');
        const addUpdateBtn = document.getElementById('add-update-btn');
        const scanBtn = document.getElementById('scan-btn');
        const readerDiv = document.getElementById('reader');

        let html5QrCode;

        scanBtn.addEventListener('click', () => {
            if (readerDiv.style.display === 'none') {
                readerDiv.style.display = 'block';
                startScanner();
            } else {
                stopScanner();
            }
        });

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const onScanSuccess = (decodedText, decodedResult) => {
                barcodeInput.value = decodedText;
                playBeep();
                stopScanner();
                const event = new KeyboardEvent('keypress', { key: 'Enter', bubbles: true });
                barcodeInput.dispatchEvent(event);
            };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    alert("Error al iniciar la c√°mara. Aseg√∫rate de dar los permisos necesarios.");
                    stopScanner();
                });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    readerDiv.style.display = 'none';
                    html5QrCode = null;
                }).catch(err => console.error("Error al detener el esc√°ner", err));
            }
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) { console.warn("No se pudo reproducir sonido de bip.") }
        }



        barcodeInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (!barcode) return;

                const doc = await inventoryCollection.doc(barcode).get();
                if (doc.exists) {
                    const data = doc.data();
                    nameInput.value = data.name;
                    categoryInput.value = data.category;
                    unitInput.value = data.unit;
                    quantityInput.focus();
                } else {
                    // Si no existe, prepara para ingreso manual y pone foco en el nombre
                    nameInput.value = '';
                    categoryInput.value = 'VARIOS (Generico)'; // O un valor por defecto
                    unitInput.value = 'uni';
                    nameInput.focus(); // <-- FOCO AUTOM√ÅTICO
                }
            }
        });
        
        const addOrUpdateItem = async () => {
            const barcode = barcodeInput.value.trim();
            const name = nameInput.value.trim();
            const category = categoryInput.value;
            const quantity = parseFloat(quantityInput.value);
            const unit = unitInput.value;

            if (!barcode || !name || isNaN(quantity)) {
                alert('Por favor, completa C√≥digo, Nombre y Cantidad.');
                return;
            }

            const docRef = inventoryCollection.doc(barcode);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (doc.exists) {
                        const newQuantity = (doc.data().quantity || 0) + quantity;
                        transaction.update(docRef, { quantity: newQuantity });
                    } else {
                        transaction.set(docRef, { name, category, quantity, unit });
                    }
                });
                barcodeInput.value = '';
                nameInput.value = '';
                quantityInput.value = '';
                barcodeInput.focus();
            } catch (error) {
                alert("Error al guardar el producto.");
            }
        };
        addUpdateBtn.addEventListener('click', addOrUpdateItem);

        inventoryCollection.orderBy("category").orderBy("name").onSnapshot(snapshot => {
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';

            const itemsByCategory = {};
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            const categoryOrder = Object.keys(itemsByCategory).sort();

            for (const category of categoryOrder) {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                inventoryDisplay.appendChild(categoryTitle);

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Cantidad Actual</th>
                            <th>Unidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                itemsByCategory[category].forEach(item => {
                    const row = document.createElement('tr');
                    if (item.quantity < 5 && item.unit !== 'porcentaje') {
                        row.classList.add('low-stock');
                    }
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editItem('${item.id}')">Editar</button>
                            <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">Borrar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                inventoryDisplay.appendChild(table);
            }
        }, error => { console.error("Error de √≠ndice:", error); alert("‚ö†Ô∏è Falta crear el √≠ndice en Firebase. Revisa la consola (F12) para ver el link."); });

        window.editItem = async (id) => {
            const doc = await inventoryCollection.doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                barcodeInput.value = id;
                nameInput.value = data.name;
                categoryInput.value = data.category;
                unitInput.value = data.unit;
                quantityInput.value = data.quantity;
                barcodeInput.disabled = true;
                
                addUpdateBtn.textContent = 'üíæ Actualizar Producto';
                addUpdateBtn.onclick = async () => {
                    const updatedName = nameInput.value.trim();
                    if (!id || !updatedName) return;
                    
                    await inventoryCollection.doc(id).set({
                        name: updatedName,
                        category: categoryInput.value,
                        unit: unitInput.value,
                        quantity: parseFloat(quantityInput.value) || 0
                    }, { merge: true });

                    barcodeInput.value = '';
                    nameInput.value = '';
                    quantityInput.value = '';
                    barcodeInput.disabled = false;
                    barcodeInput.focus();
                    addUpdateBtn.textContent = '‚ûï Agregar / Actualizar Stock';
                    addUpdateBtn.onclick = addOrUpdateItem;
                };
            }
        };

        window.deleteItem = async (id) => {
            if (confirm(`¬øSeguro que quieres borrar el producto '${id}'?`)) {
                await inventoryCollection.doc(id).delete();
            }
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const catalogList = document.getElementById('catalog-list');
            const aiAnalysisBtn = document.getElementById('ai-analysis-btn');

            const localProducts = [
                "Churritos Diana", "Nachos Diana", "Elotitos Diana", "Tortillitas Diana", "Pizzerolas Diana",
                "Bocadeli Nachos", "Bocadeli Frijoli Chips", "Bocadeli Papas Onduladas",
                "Cerveza Pilsener", "Cerveza Regia", "Cerveza Suprema", "Cerveza Golden",
                "Coca Cola", "Kolashampan", "Pepsi", "Mirinda", "7up",
                "Leche Salud", "Yogurt Sula", "Leche Leyde", "Queso Crio",
                "Jugo del Valle", "Jugo Petit",
                "Boquitas Diana Variedad",
                "Queso Mozzarella", "Queso Duro Blando", "Queso Oaxaca",
                "Cafe Riko", "Cafe Listo"
            ];

            localProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                catalogList.appendChild(option);
            });

            const analizarInventarioIA = () => {
                const rows = document.querySelectorAll('#inventory-display tbody tr');
                let criticos = 0;
                let exceso = 0;
                let valorTotal = 0;
                let productosCriticos = [];
                let hayCervezasBajas = false;
                let hayQuesoBajo = false;

                rows.forEach(row => {
                    const quantity = parseFloat(row.cells[2].textContent);
                    const name = row.cells[1].textContent.toLowerCase();
                    const id = row.cells[0].textContent.toLowerCase();

                    if (!isNaN(quantity)) {
                        if (quantity < 5) {
                            criticos++;
                            productosCriticos.push(row.cells[1].textContent);
                        }
                        if (quantity > 50) {
                            exceso++;
                        }
                        valorTotal += quantity; 

                        if (name.includes('cerveza') && quantity < 10) {
                            hayCervezasBajas = true;
                        }
                        if (id.includes('queso') && quantity < 2) {
                            hayQuesoBajo = true;
                        }
                    }
                });

                let consejo = "Todo parece en orden.";
                if (hayCervezasBajas) {
                    consejo = "Se detecta bajo inventario de cervezas. Sugerencia: Preparar pedido a La Constancia para el fin de semana.";
                }
                if (hayQuesoBajo) {
                    consejo = "¬°Alerta de cocina! Niveles de queso son cr√≠ticos. Hay riesgo de parar la producci√≥n de pizzas y pupusas.";
                }

                const analisis = `
                    An√°lisis de Inventario con IA completado:
                    - Productos Cr√≠ticos (<5 unidades): ${criticos}
                    - Productos en Exceso (>50 unidades): ${exceso}
                    - Total de Items: ${valorTotal.toFixed(2)}
                    
                    Consejo Inteligente: ${consejo}
                `;

                alert(analisis);

                if ('speechSynthesis' in window) {
                    const mensaje = new SpeechSynthesisUtterance(analisis);
                    window.speechSynthesis.speak(mensaje);
                }
            };

            aiAnalysisBtn.addEventListener('click', analizarInventarioIA);
        });

        document.getElementById('btn-wipe-all').addEventListener('click', async () => {
            if (confirm('¬øSeguro que quieres borrar TODO el inventario? Esta acci√≥n es irreversible.')) {
                try {
                    const querySnapshot = await inventoryCollection.get();
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    alert('Inventario vaciado correctamente.');
                } catch (error) {
                    console.error("Error al vaciar el inventario: ", error);
                    alert('Hubo un error al intentar vaciar el inventario.');
                }
            }
        });
    </script>
</body>
</html>
