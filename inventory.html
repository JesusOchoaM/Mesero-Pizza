<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - Just Great Pizza</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #FF9800;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .form-container, .inventory-container {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background-color: #2c2c2c;
            color: #fff;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #FF9800;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        #add-update-btn {
            grid-column: 1 / -1;
        }
        .barcode-container {
            display: flex;
            gap: 5px;
            grid-column: 1 / -1;
        }
        #scan-btn {
            width: auto;
            padding: 10px 15px;
            background-color: #03A9F4;
            color: white;
        }
        #reader {
            width: 300px;
            margin: 15px auto;
            border: 2px dashed #333;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
            color: #FF9800;
        }
        .low-stock {
            background-color: #8B0000;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            width: auto;
        }
        .btn-edit { background-color: #03A9F4; color: white; }
        .btn-delete { background-color: #f44336; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ“¦ GestiÃ³n de Inventario</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="temp-load-btn" style="background-color: #f44336; color: white; width: auto; padding: 10px 20px;">âš¡ Cargar Inventario Completo</button>
        </div>

        <div class="form-container">
            <div id="inventory-form" class="form-grid">
                <div class="barcode-container">
                    <input type="text" id="barcode" placeholder="CÃ³digo de Barra" autofocus>
                    <button id="scan-btn">ðŸ“· Escanear</button>
                </div>
                <input type="text" id="product-name" placeholder="Nombre del Producto">
                <select id="category">
                    <option value="SIGMA">SIGMA</option>
                    <option value="LACTOSA">LACTOSA</option>
                    <option value="MULTI CONGELADOS">MULTI CONGELADOS</option>
                    <option value="SELLO DE ORO">SELLO DE ORO</option>
                    <option value="PRICE SMART">PRICE SMART</option>
                    <option value="VARIOS (Generico)">VARIOS (Generico)</option>
                    <option value="LA SABROSURA">LA SABROSURA</option>
                    <option value="SUPER SELECTOS">SUPER SELECTOS</option>
                    <option value="BEBIDAS Y CERVEZAS">BEBIDAS Y CERVEZAS</option>
                    <option value="VERDURAS Y OTROS">VERDURAS Y OTROS</option>
                </select>
                <input type="number" id="quantity" placeholder="Cantidad">
                <select id="unit">
                    <option value="lb">lb</option>
                    <option value="uni">uni</option>
                    <option value="paq">paq</option>
                    <option value="lata">lata</option>
                    <option value="orden">orden</option>
                    <option value="porcentaje">porcentaje</option>
                    <option value="libra">libra</option>
                    <option value="bandeja">bandeja</option>
                    <option value="bolsa">bolsa</option>
                </select>
                <button id="add-update-btn">âž• Agregar / Actualizar Stock</button>
            </div>
            <div id="reader" style="display: none;"></div>
        </div>

        <div class="inventory-container">
            <h2>Stock Actual</h2>
            <div style="overflow-x:auto;">
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Nombre</th>
                            <th>CategorÃ­a</th>
                            <th>Cantidad Actual</th>
                            <th>Unidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBHTqTXaNChhDaskwJTzQGTBfyxR_Qq0nI",
          authDomain: "just-great-pizza-system.firebaseapp.com",
          projectId: "just-great-pizza-system",
          storageBucket: "just-great-pizza-system.firebasestorage.app",
          messagingSenderId: "30074620354",
          appId: "1:30074620354:web:4f1f36fad96ac2cad2ae5b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const inventoryCollection = db.collection("inventario");

        const barcodeInput = document.getElementById('barcode');
        const nameInput = document.getElementById('product-name');
        const categoryInput = document.getElementById('category');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');
        const addUpdateBtn = document.getElementById('add-update-btn');
        const inventoryBody = document.getElementById('inventory-body');
        const tempLoadBtn = document.getElementById('temp-load-btn');
        const scanBtn = document.getElementById('scan-btn');
        const readerDiv = document.getElementById('reader');

        let html5QrCode;

        scanBtn.addEventListener('click', () => {
            if (readerDiv.style.display === 'none') {
                readerDiv.style.display = 'block';
                startScanner();
            } else {
                stopScanner();
            }
        });

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const onScanSuccess = (decodedText, decodedResult) => {
                barcodeInput.value = decodedText;
                playBeep();
                stopScanner();
                const event = new KeyboardEvent('keypress', { key: 'Enter', bubbles: true });
                barcodeInput.dispatchEvent(event);
            };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    alert("Error al iniciar la cÃ¡mara. AsegÃºrate de dar los permisos necesarios.");
                    stopScanner();
                });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    readerDiv.style.display = 'none';
                    html5QrCode = null;
                }).catch(err => console.error("Error al detener el escÃ¡ner", err));
            }
        }

        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) { console.warn("No se pudo reproducir sonido de bip.") }
        }

        tempLoadBtn.addEventListener('click', async () => {
            if (!confirm("Â¿EstÃ¡s seguro de que quieres cargar el inventario completo? Esto puede sobrescribir datos existentes.")) {
                return;
            }

            const inventoryBySupplier = {
                "SIGMA": ["Chorizo (uni)", "Peperoni (lb)", "JamÃ³n ahumado (lb)", "JamÃ³n pavo (bandeja)", "Tocino (uni)", "Salchicha con queso (paq)"],
                "LACTOSA": ["Queso mozzarella (lb)", "Queso amarillo (uni)", "Crema (uni)", "Yogurt (uni)"],
                "MULTI CONGELADOS": ["Papas (lb)", "Nuguet pollo (uni)", "Pan hamburguesa (uni)", "Pechugas (orden)", "Tacos (orden)"],
                "SELLO DE ORO": ["Alitas (bolsa)", "Nuguet pollo Sello Oro (uni)", "Tacos Sello Oro (orden)"],
                "PRICE SMART": ["Camarones (uni)", "Deditos de queso (orden)", "Pollo (uni)", "Costilla (orden)", "BBQ (uni)", "BÃºfalo (uni)", "Ranch (uni)", "Ketchup (uni)", "Ketchup bolsita (uni)", "Aluminio (porcentaje)", "Mayonesa (uni)", "Margarina (uni)", "Agua (uni)", "Salsa pizza (lata)", "Aceite (porcentaje)", "Aceitunas (porcentaje)", "Hongos (porcentaje)", "KS (uni)", "AzÃºcar (libra)", "Sal (libra)", "LimÃ³n (uni)"],
                "VARIOS (Generico)": ["Harina pan cake (porcentaje)", "Nutella (uni)", "Hershey (uni)", "Chantilly (porcentaje)", "Salsa negra (porcentaje)", "Mostaza (porcentaje)", "Jugo de Naranja (porcentaje)", "Leche (porcentaje)", "Salsa Alfredo (uni)", "Wantan (orden)"],
                "LA SABROSURA": ["Cajas (uni)", "Queso parmesano (uni)", "Chile escamas (uni)"],
                "SUPER SELECTOS": ["Pan hot dog (bolsa)", "Pan caja (porcentaje)", "Frijoles (lb)", "CafÃ© (uni)", "Harina de arroz (lb)", "Harina maiz (lb)", "Carne molida H. (uni)", "Maicena (porcentaje)", "Consome pollo (uni)", "Consome carne (uni)", "Sopas Maggi (uni)", "Maruchan (uni)", "LasaÃ±a (orden)", "Caja lasaÃ±a (uni)", "Miel de maple (porcentaje)", "Granola (porcentaje)", "Avena (porcentaje)", "Huevos (uni)", "Caramelo Hershey (uni)", "Dulce de leche (porcentaje)", "Toallas hÃºmedas (uni)"],
                "BEBIDAS Y CERVEZAS": [ "Coca Cola lata (uni)", "Coca Cola vidrio (uni)", "Kolashampan lata (uni)", "Agua embotellada (uni)", "Cerveza Pilsener (uni)", "Cerveza Golden (uni)" ], 
                "VERDURAS Y OTROS": [ "Tomate (lb)", "Cebolla blanca (lb)", "Cebolla morada (lb)", "Chile verde (uni)", "Hongos frescos (lb)", "Ajo (cabeza)" ]
            };

            const batch = db.batch();
            const regex = /(.*) \((.*)\)/;

            for (const category in inventoryBySupplier) {
                for (const productString of inventoryBySupplier[category]) {
                    const match = productString.match(regex);
                    if (match) {
                        const name = match[1].trim();
                        const unit = match[2].trim();
                        const docId = name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
                        const docRef = inventoryCollection.doc(docId);
                        batch.set(docRef, { name, category, unit, quantity: 0 });
                    }
                }
            }

            try {
                await batch.commit();
                alert('Â¡Inventario completo cargado con Ã©xito! Todos los items se inicializaron con cantidad 0.');
            } catch (error) {
                console.error("Error al cargar la lista: ", error);
                alert('Hubo un error al cargar la lista. Revisa la consola.');
            }
        });

        barcodeInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (!barcode) return;

                const doc = await inventoryCollection.doc(barcode).get();
                if (doc.exists) {
                    const data = doc.data();
                    nameInput.value = data.name;
                    categoryInput.value = data.category;
                    unitInput.value = data.unit;
                    quantityInput.focus();
                } else {
                    nameInput.value = '';
                    categoryInput.value = 'SIGMA';
                    unitInput.value = 'uni';
                    nameInput.focus();
                }
            }
        });
        
        const addOrUpdateItem = async () => {
            const barcode = barcodeInput.value.trim();
            const name = nameInput.value.trim();
            const category = categoryInput.value;
            const quantity = parseFloat(quantityInput.value);
            const unit = unitInput.value;

            if (!barcode || !name || isNaN(quantity)) {
                alert('Por favor, completa CÃ³digo, Nombre y Cantidad.');
                return;
            }

            const docRef = inventoryCollection.doc(barcode);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    if (doc.exists) {
                        const newQuantity = (doc.data().quantity || 0) + quantity;
                        transaction.update(docRef, { quantity: newQuantity });
                    } else {
                        transaction.set(docRef, { name, category, quantity, unit });
                    }
                });
                barcodeInput.value = '';
                nameInput.value = '';
                quantityInput.value = '';
                barcodeInput.focus();
            } catch (error) {
                alert("Error al guardar el producto.");
            }
        };
        addUpdateBtn.addEventListener('click', addOrUpdateItem);

        inventoryCollection.orderBy("category").orderBy("name").onSnapshot(snapshot => {
            inventoryBody.innerHTML = '';
            snapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const row = document.createElement('tr');
                if (item.quantity < 5 && item.unit !== 'porcentaje') {
                    row.classList.add('low-stock');
                }
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">Editar</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">Borrar</button>
                    </td>
                `;
                inventoryBody.appendChild(row);
            });
        }, error => { console.error("Error de Ã­ndice:", error); alert("âš ï¸ Falta crear el Ã­ndice en Firebase. Revisa la consola (F12) para ver el link."); });

        window.editItem = async (id) => {
            const doc = await inventoryCollection.doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                barcodeInput.value = id;
                nameInput.value = data.name;
                categoryInput.value = data.category;
                unitInput.value = data.unit;
                quantityInput.value = data.quantity;
                barcodeInput.disabled = true;
                
                addUpdateBtn.textContent = 'ðŸ’¾ Actualizar Producto';
                addUpdateBtn.onclick = async () => {
                    const updatedName = nameInput.value.trim();
                    if (!id || !updatedName) return;
                    
                    await inventoryCollection.doc(id).set({
                        name: updatedName,
                        category: categoryInput.value,
                        unit: unitInput.value,
                        quantity: parseFloat(quantityInput.value) || 0
                    }, { merge: true });

                    barcodeInput.value = '';
                    nameInput.value = '';
                    quantityInput.value = '';
                    barcodeInput.disabled = false;
                    barcodeInput.focus();
                    addUpdateBtn.textContent = 'âž• Agregar / Actualizar Stock';
                    addUpdateBtn.onclick = addOrUpdateItem;
                };
            }
        };

        window.deleteItem = async (id) => {
            if (confirm(`Â¿Seguro que quieres borrar el producto '${id}'?`)) {
                await inventoryCollection.doc(id).delete();
            }
        };
    </script>
</body>
</html>
